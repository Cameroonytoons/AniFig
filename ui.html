<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font: 12px sans-serif;
      margin: 0;
      padding: 16px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
    }

    #app {
      opacity: 0;
      transition: opacity 0.3s ease;
      display: none;
    }

    #app.loaded {
      opacity: 1;
      display: block;
    }

    #loading {
      text-align: center;
      padding: 20px;
      font-weight: 500;
    }

    .error-state {
      display: none;
      color: #e34850;
      text-align: center;
      padding: 20px;
      margin: 20px;
      border: 1px solid #e34850;
      border-radius: 4px;
      background: #fff5f5;
    }

    .section {
      margin-bottom: 24px;
    }

    .input-group {
      margin-bottom: 12px;
      position: relative;
    }

    .error-message {
      color: #e34850;
      font-size: 11px;
      margin-top: 4px;
      display: none;
    }

    .input-group.error .error-message {
      display: block;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin: 4px 0;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }

    .input-group.error input {
      border-color: #e34850;
    }

    button {
      width: 100%;
      padding: 8px 16px;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 4px 0;
    }

    button:hover {
      background: var(--figma-color-bg-brand-hover);
    }

    .preview-container {
      margin: 16px 0;
      padding: 16px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
    }

    .preview-box {
      width: 50px;
      height: 50px;
      background: var(--figma-color-bg-brand);
      margin: 0 auto;
    }

    .animation-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      margin-top: 8px;
    }

    .animation-item {
      padding: 12px;
      border-bottom: 1px solid var(--figma-color-border);
      cursor: pointer;
    }

    .animation-item:hover {
      background: var(--figma-color-bg-hover);
    }

    .animation-item.selected {
      background: var(--figma-color-bg-selected);
    }

    .group-header {
      padding: 8px;
      background: var(--figma-color-bg-secondary);
      font-weight: 500;
    }

    .description {
      margin: 4px 0;
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }

    .tooltip {
      display: inline-block;
      width: 16px;
      height: 16px;
      line-height: 16px;
      text-align: center;
      border-radius: 50%;
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
      font-size: 10px;
      cursor: help;
      margin-left: 4px;
      position: relative;
    }

    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      background: var(--figma-color-bg);
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      max-width: 200px;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      left: 50%;
      transform: translateX(-50%);
      top: 100%;
      margin-top: 8px;
    }
    .loader {
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--figma-color-bg-brand);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #loading-status, #loading-details {
      text-align: center;
      margin: 8px 0;
    }

    #loading-details {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }
  </style>
</head>
<body>
  <div id="error-state" class="error-state">
    <h3>Error</h3>
    <p>Failed to initialize plugin. Please try reloading.</p>
  </div>

  <div id="app">
    <div id="loading">
      <div class="loader"></div>
      <p id="loading-status">Initializing Animation Library Manager...</p>
      <p id="loading-details"></p>
    </div>
  </div>

<script>
    const MAX_RETRIES = 5;
    let retryCount = 0;
    let loadingTimeout = null;

    function showError(message, details) {
        console.error('Error occurred:', message, details);
        const errorState = document.getElementById('error-state');
        const loading = document.getElementById('loading');

        if (errorState) {
            const errorMessage = errorState.querySelector('p') || document.createElement('p');
            errorMessage.textContent = message;
            if (!errorState.contains(errorMessage)) {
                errorState.appendChild(errorMessage);
            }
            if (details) {
                const detailsElement = document.createElement('p');
                detailsElement.style.fontSize = '11px';
                detailsElement.style.color = '#666';
                detailsElement.textContent = details;
                errorState.appendChild(detailsElement);
            }
            errorState.style.display = 'block';
        }

        if (loading) {
            loading.style.display = 'none';
        }
    }

    function updateLoadingStatus(message, details) {
        console.log('Loading status:', message, details || '');
        const status = document.getElementById('loading-status');
        const detailsElement = document.getElementById('loading-details');

        if (status) {
            status.textContent = message;
        }
        if (detailsElement) {
            detailsElement.textContent = details || '';
        }
    }

    async function getPluginResourcePath(filename) {
        try {
            const scripts = document.getElementsByTagName('script');
            const currentScript = scripts[scripts.length - 1];
            if (currentScript && currentScript.src) {
                const scriptPath = currentScript.src;
                const rootPath = scriptPath.substring(0, scriptPath.lastIndexOf('/') + 1);
                console.log('Root path from script:', rootPath);
                return `${rootPath}${filename}`;
            }

            // Fallback to window location if script path not available
            const baseUrl = window.location.href.split('/').slice(0, -1).join('/');
            console.log('Base URL from location:', baseUrl);
            return `${baseUrl}/${filename}`;
        } catch (error) {
            console.error('Error getting resource path:', error);
            return filename;
        }
    }

    async function loadScript(filename) {
        const maxRetries = 5;
        const maxDelay = 5000;
        let retryCount = 0;

        while (retryCount < maxRetries) {
            try {
                const scriptPath = await getPluginResourcePath(filename);
                console.log('Attempting to load script from:', scriptPath);

                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = scriptPath;
                    script.async = true;
                    script.crossOrigin = "anonymous";

                    const timeoutId = setTimeout(() => {
                        script.remove();
                        const error = new Error(`Script load timed out: ${filename}`);
                        console.error('Script load timeout:', error);
                        reject(error);
                    }, 10000);

                    script.onload = () => {
                        clearTimeout(timeoutId);
                        console.log('Script loaded successfully:', filename);
                        resolve();
                    };

                    script.onerror = async (error) => {
                        clearTimeout(timeoutId);
                        script.remove();
                        console.error('Script load error:', error);

                        if (++retryCount < maxRetries) {
                            console.log(`Retrying script load (${retryCount}/${maxRetries})`);
                            const delay = Math.min(1000 * Math.pow(2, retryCount), maxDelay);
                            updateLoadingStatus('Retrying script load...', 
                                `Attempt ${retryCount + 1} of ${maxRetries}`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            try {
                                await loadScript(filename);
                                resolve();
                            } catch (retryError) {
                                console.error('Retry attempt failed:', retryError);
                                reject(retryError);
                            }
                        } else {
                            const finalError = new Error(`Failed to load script after ${maxRetries} attempts`);
                            console.error('Max retries exceeded:', finalError);
                            reject(finalError);
                        }
                    };

                    document.body.appendChild(script);
                    console.log('Script element added to document:', script.src);
                });
            } catch (error) {
                console.error('Script load attempt failed:', error);
                if (++retryCount >= maxRetries) {
                    console.error('All retry attempts failed');
                    throw error;
                }
                const delay = Math.min(1000 * Math.pow(2, retryCount), maxDelay);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        console.log('DOM Content Loaded, starting initialization');

        loadingTimeout = setTimeout(() => {
            console.error('Plugin initialization timeout triggered');
            showError(
                'Plugin initialization timed out',
                'The plugin took too long to load. Please check your connection and reload.'
            );
        }, 30000);

        try {
            updateLoadingStatus('Starting initialization...');
            console.log('Loading UI bundle...');

            try {
                await loadScript('build/ui.js');
                console.log('UI bundle loaded successfully');
                updateLoadingStatus('UI loaded', 'Initializing plugin...');

                if (!window.UI) {
                    const error = new Error('UI module not found after script load');
                    console.error('UI module missing:', error);
                    throw error;
                }

                if (loadingTimeout) {
                    clearTimeout(loadingTimeout);
                    loadingTimeout = null;
                }

                try {
                    console.log('Initializing UI instance');
                    window.UI.getInstance();
                    console.log('UI initialized successfully');
                    updateLoadingStatus('Plugin initialized successfully');
                } catch (initError) {
                    console.error('UI initialization error:', initError);
                    throw new Error(`UI initialization failed: ${initError.message}`);
                }

            } catch (error) {
                console.error('Script loading error:', error);
                throw new Error(`Script loading failed: ${error.message}`);
            }
        } catch (error) {
            console.error('Initialization error:', error);
            showError(
                'Failed to initialize plugin',
                `Please check your connection and reload. Error: ${error.message}`
            );
        }
    });

    window.addEventListener('unload', () => {
        if (loadingTimeout) {
            console.log('Cleaning up timeout on unload');
            clearTimeout(loadingTimeout);
        }
    });

    window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Global error:', msg, 'at', lineNo, ':', columnNo);
        console.error('Stack:', error?.stack);
        showError('An unexpected error occurred', error?.message || msg);
        return false;
    };
</script>
</body>
</html>