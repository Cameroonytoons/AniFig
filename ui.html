<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font: 12px sans-serif;
      margin: 0;
      padding: 16px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
    }

    #app {
      opacity: 0;
      transition: opacity 0.3s ease;
      display: none;
    }

    #app.loaded {
      opacity: 1;
      display: block;
    }

    #loading {
      text-align: center;
      padding: 20px;
      font-weight: 500;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
    }

    .loader {
      border: 2px solid var(--figma-color-bg-secondary);
      border-top: 2px solid var(--figma-color-bg-brand);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 16px auto;
    }

    .loading-step {
      font-size: 12px;
      color: var(--figma-color-text);
      margin: 4px 0;
      opacity: 0.7;
    }

    .loading-step.completed {
      color: var(--figma-color-text-secondary);
      text-decoration: line-through;
    }

    .loading-step.error {
      color: #e34850;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-state {
      display: none;
      color: #e34850;
      text-align: center;
      padding: 20px;
      margin: 20px;
      border: 1px solid #e34850;
      border-radius: 4px;
      background: #fff5f5;
    }

    .section {
      margin-bottom: 24px;
      padding: 16px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
    }

    .input-group {
      margin-bottom: 12px;
      position: relative;
    }

    .error-message {
      color: #e34850;
      font-size: 11px;
      margin-top: 4px;
      display: none;
    }

    .input-group.error .error-message {
      display: block;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin: 4px 0;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }

    .input-group.error input {
      border-color: #e34850;
    }

    button {
      width: 100%;
      padding: 8px 16px;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 4px 0;
    }

    button:hover {
      background: var(--figma-color-bg-brand-hover);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .preview-container {
      margin: 16px 0;
      padding: 16px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      text-align: center;
    }

    .preview-box {
      width: 50px;
      height: 50px;
      background: var(--figma-color-bg-brand);
      margin: 0 auto 16px;
      border-radius: 4px;
    }

    .animation-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      margin-top: 8px;
    }

    .animation-item {
      padding: 12px;
      border-bottom: 1px solid var(--figma-color-border);
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .animation-item:last-child {
      border-bottom: none;
    }

    .animation-item:hover {
      background: var(--figma-color-bg-hover);
    }

    .animation-item.selected {
      background: var(--figma-color-bg-selected);
    }

    .group-header {
      padding: 8px;
      background: var(--figma-color-bg-secondary);
      font-weight: 500;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .description {
      margin: 4px 0;
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }

    .tooltip {
      display: inline-block;
      width: 16px;
      height: 16px;
      line-height: 16px;
      text-align: center;
      border-radius: 50%;
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
      font-size: 10px;
      cursor: help;
      margin-left: 4px;
      position: relative;
    }

    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      background: var(--figma-color-bg);
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      max-width: 200px;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      left: 50%;
      transform: translateX(-50%);
      top: 100%;
      margin-top: 8px;
      white-space: pre-wrap;
    }

    .retry-button {
      max-width: 120px;
      margin: 16px auto;
      display: block;
    }

    .error-stack {
      font-family: monospace;
      font-size: 11px;
      margin-top: 16px;
      padding: 8px;
      background: rgba(227, 72, 80, 0.1);
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="error-state" class="error-state">
    <h3>Error</h3>
    <p></p>
    <button id="retry-button" class="retry-button">Retry</button>
  </div>

  <div id="app">
    <div id="loading">
      <div class="loader"></div>
      <div id="loading-steps">
        <div class="loading-step" data-step="init">Initializing plugin...</div>
        <div class="loading-step" data-step="scripts">Loading required scripts...</div>
        <div class="loading-step" data-step="store">Setting up data store...</div>
        <div class="loading-step" data-step="ui">Preparing user interface...</div>
      </div>
    </div>
  </div>

<script>
    const INIT_TIMEOUT = 15000; // Increased to 15 seconds
    const RETRY_ATTEMPTS = 5;   // Increased retry attempts
    const RETRY_DELAY = 2000;   // Increased delay between retries
    let loadingTimeout = null;
    let currentStep = 'init';

    function updateLoadingStep(step, status = 'pending') {
        const steps = document.querySelectorAll('.loading-step');
        steps.forEach(s => {
            if (s.dataset.step === step) {
                s.classList.remove('completed', 'error');
                if (status === 'completed') {
                    s.classList.add('completed');
                } else if (status === 'error') {
                    s.classList.add('error');
                }
            }
        });
    }

    function showError(message, details = '') {
        console.error('Error occurred:', message, details);
        const errorState = document.getElementById('error-state');
        const loading = document.getElementById('loading');

        if (errorState) {
            errorState.style.display = 'block';
            const errorMessage = errorState.querySelector('p');
            if (errorMessage) {
                errorMessage.textContent = message;
                if (details) {
                    const detailsElem = document.createElement('p');
                    detailsElem.textContent = details;
                    detailsElem.style.fontSize = '11px';
                    errorState.appendChild(detailsElem);
                }
            }

            const retryButton = document.getElementById('retry-button');
            if (retryButton) {
                retryButton.onclick = () => {
                    errorState.style.display = 'none';
                    if (loading) loading.style.display = 'block';
                    initializePlugin();
                };
            }
        }

        if (loading) {
            loading.style.display = 'none';
        }

        updateLoadingStep(currentStep, 'error');
    }

    async function loadScript(filename, attempt = 1) {
        try {
            currentStep = 'scripts';
            updateLoadingStep('scripts');

            const scriptPath = `${window.location.href.split('/').slice(0, -1).join('/')}/${filename}`;
            console.log(`Loading script (attempt ${attempt}/${RETRY_ATTEMPTS}):`, scriptPath);

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = scriptPath;
                script.async = true;
                script.crossOrigin = "anonymous";

                const timeoutId = setTimeout(() => {
                    script.remove();
                    reject(new Error(`Script load timed out after ${INIT_TIMEOUT}ms: ${filename}`));
                }, INIT_TIMEOUT);

                script.onload = () => {
                    clearTimeout(timeoutId);
                    console.log('Script loaded successfully:', filename);
                    updateLoadingStep('scripts', 'completed');
                    resolve();
                };

                script.onerror = async (error) => {
                    clearTimeout(timeoutId);
                    script.remove();
                    console.error(`Script load error (attempt ${attempt}):`, error);

                    if (attempt < RETRY_ATTEMPTS) {
                        updateLoadingStep('scripts');
                        await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
                        try {
                            await loadScript(filename, attempt + 1);
                            resolve();
                        } catch (retryError) {
                            reject(new Error(`Failed to load script after ${attempt} attempts: ${retryError.message}`));
                        }
                    } else {
                        updateLoadingStep('scripts', 'error');
                        reject(new Error(`Failed to load script after ${RETRY_ATTEMPTS} attempts`));
                    }
                };

                document.body.appendChild(script);
            });
        } catch (error) {
            if (attempt < RETRY_ATTEMPTS) {
                await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
                return loadScript(filename, attempt + 1);
            }
            throw error;
        }
    }

    async function initializePlugin() {
        currentStep = 'init';
        updateLoadingStep('init');

        if (loadingTimeout) {
            clearTimeout(loadingTimeout);
        }

        loadingTimeout = setTimeout(() => {
            showError(
                'Plugin initialization timed out',
                'The plugin took too long to initialize. Please try again.'
            );
        }, INIT_TIMEOUT);

        try {
            updateLoadingStep('init', 'completed');
            await loadScript('build/ui.js');

            currentStep = 'store';
            updateLoadingStep('store');

            if (!window.UI) {
                throw new Error('UI module not loaded correctly');
            }

            const ui = window.UI.getInstance();
            if (!ui) {
                throw new Error('Failed to create UI instance');
            }

            updateLoadingStep('store', 'completed');
            currentStep = 'ui';
            updateLoadingStep('ui');

            // Clear timeout if everything succeeded
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
            }

            const app = document.getElementById('app');
            if (app) {
                app.classList.add('loaded');
                updateLoadingStep('ui', 'completed');
            }
        } catch (error) {
            const errorMessage = error.message || 'Unknown error occurred';
            const errorDetails = error.stack ? error.stack.split('\n')[0] : '';
            showError(
                'Failed to initialize plugin',
                errorDetails ? `${errorMessage}\n${errorDetails}` : errorMessage
            );
            throw error;
        }
    }

    document.addEventListener('DOMContentLoaded', initializePlugin);

    window.addEventListener('unload', () => {
        if (loadingTimeout) {
            clearTimeout(loadingTimeout);
        }
    });

    window.onerror = (msg, url, lineNo, columnNo, error) => {
        showError(
            'An unexpected error occurred',
            `${msg}\nLocation: ${url}:${lineNo}:${columnNo}`
        );
        return false;
    };
</script>
</body>
</html>